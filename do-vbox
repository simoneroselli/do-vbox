#!/usr/bin/env python
#
# Author: ZMo <simoneroselli78gmail.com>
#
# Auto-setup for VirtualBox virtual machines:
# retrieve vm from http repository / install / and
# configure 

# Local custom settings
import config

import os, sys, re
import urllib, urllib2, httplib
import argparse, urlparse, zipfile
import shutil, hashlib, grp

vbox_repository = config.url
vbox_repository_list = vbox_repository + 'vbox-index'
vbox_list_file = '/tmp/vbox-list-file'
vbox_setup_dir = '/usr/local/vbox'

if len(sys.argv) < 2:
    print help
    exit()

# Write func
def writeFile(filename, data):
    fd = open(filename, 'w')
    fd.write(data)
    fd.close()

# Parse URL
def getVm(url, local_file):
    x = urlparse.urlparse(url)
    conn = httplib.HTTPConnection(x.netloc)
    conn.request("GET", x.path)
    res = conn.getresponse()
    if res.status in (404, 403):
        raise IOError(res.reason)
    
    # 2 cents download progress counter
    downloaded = 0
    fd = open(local_file, 'w')
    while True:
        data = res.read(512*1024)
        if len(data) == 0:
            break
        downloaded += len(data)
        fd.write(data)
        sys.stdout.write('\b' * 80)
        sys.stdout.write('Downloading %s..' % (sizeToHuman(downloaded)))
    fd.close()
    conn.close()
    sys.stdout.write('\n')

def sizeToHuman(size):
    kb = 1024.0
    mb = 1024.0 *kb
    gb = 1024.0 *mb
    if size >= gb:
        return '%.2fGiB' % (size / gb)
    if size >= mb:
        return '%.2fMiB' % (size / mb)
    if size >= kb:
        return '%.2fKiB' % (size / kb)
    return '%dbyte' % size

# Retrive vbox list from http repo and store it in a file
def listFile():
    resp = urllib2.urlopen(vbox_repository_list, timeout=5)
    vbox_list = resp.read()
    writeFile(vbox_list_file, vbox_list)

# Read
def readfile(filename):
    f = file(filename)
    while True:
        line = f.readline()
        if len(line) == 0:
            break
        print line,
    f.close()

# Grep
def grep(string, filename):
    for line in open(filename).readlines():
        match = re.search(string + '.*', line)
        if match is not None:
            print match.group(0)

# Mkdir
def makeDir(dir):
    if not os.path.exists(dir):
        print 'Creating %s' % (dir)
        os.makedirs(dir, mode=0777)
    
    os.chmod(dir, 0777)

# Move
def move(src, dest):
    if os.path.isdir(dest):
        shutil.move(src, dest)
    else:
        os.makedirs(dest, mode=0777)
        shutil.move(src, dest)

# MD5 sum
def md5Sum(filename):
    f = open(filename, 'r')
    md5 = hashlib.md5()
    while True:
        data = f.read(8196)
        if not data:
            break
        md5.update(data)

    md5hash = md5.hexdigest()
    f.close()
    return md5hash

# Class to handle vbox-index text file into the script
class VirtualMachine(object):
	def __init__(self, name=None, md5=None, desc=None, update=None, size=None):
		self.name = name
		self.md5 = md5
		self.desc = desc
		self.update = update
		self.size = size

	def isValid(self):
		return self.name is not None and self.md5 is not None
	
	@staticmethod
	def parseFileList(filename):
		""" Modo performante secondo Lo """
		virtual_machines = []

		f = open(filename, "r")
		vm = VirtualMachine()
		for line in f:
			line = line.strip()
			if len(line) == 0:
				if vm.isValid():
					virtual_machines.append(vm)
				vm = VirtualMachine()
			else:
				# cerco i : (split su i :)
				# ottengo key: valore
				key, value = line.split(':')
				key = key.strip()
				value = value.strip()
				setattr(vm, key, value)				
		if vm.isValid():
			virtual_machines.append(vm)
		f.close()

		return virtual_machines


# Unzip
def unzip(filename, dir):
    vm_zip = zipfile.ZipFile(filename)
    for name in vm_zip.namelist():
        if name.endswith('/'):
            try:
                makeDir(os.path.join(dir, name))
            except OSError as dir_present_err:
                print dir_present_err
        
        else:
            makeDir(dir)
            vm_zip.extract(name, dir)

# Group retrieve
def checkGroup(group, gid):
    try:
        g = grp.getgrnam(group)
        return g.gr_gid == gid
    except KeyError:
        return False



# Parse
def parse():
    parser = argparse.ArgumentParser()
    parser.add_argument('--listname', action='store_true', help='List available machines')
    parser.add_argument('--update', action='store_true', help='Refresh VM list')
    parser.add_argument('--show', action='store_true', help='Display machines information')
    parser.add_argument('--download', nargs=1, help='Download only in the current dir')
    parser.add_argument('--setup', nargs=1, help='Download and configure a machine')
    return parser.parse_args()

# Parse arguments
options = parse()

# --listname
if options.listname:
    listFile()
    grep('name', vbox_list_file)

# --update
if options.update:
    listFile()
    print "Vbox list updated!"

# --show
if options.show:
    listFile()
    readfile(vbox_list_file)
    
# --download    
if options.download:
    vm_file = options.download[0]
    try:
        getVm(vbox_repository + vm_file, vm_file)
    except IOError as not_found_err:
        print 'VM "%s" %s' % (vm_file, not_found_err)
        exit()

# --setup
if options.setup:
    # On unix systems, ensure to be root
    if os.name == 'posix':
        me = os.getuid()
        if me != 0:
            print "Sorry, you must be root"
            exit()

    vm_file = options.setup[0]
    try:
       getVm(vbox_repository + vm_file, vm_file)
    except IOError as not_found_err:
        print 'VM "%s" %s' % (vm_file, not_found_err)
        exit()
	
	# Perform md5sum on dumped vm
	print "Retrive md5sum on", vm_file
    md5_vm_zip = md5Sum(vm_file)
    vms = VirtualMachine.parseFileList(vbox_list_file)
    md5_matched = False
    for vm in vms:
        if vm.md5 == md5_vm_zip:
            md5_matched = True
            md5_vm_name = vm.name
            break

    if md5_matched == True:
        print "Md5sum matched for", md5_vm_name, ".."
    else:
        print "Md5sum failed, please retry download again"
        print "or send an email to simoneroselli78@gmail.com"
        print "reporting the incident"

    # Unpack the vm to /usr/local/vbox/
    print 'Unzip', vm_file, 'to', vbox_setup_dir, '..'
    unzip(vm_file, vbox_setup_dir)

    # Set permissions for /usr/local/vbox
    if os.name == 'posix' and checkGroup('staff', 50) == True:
        print "Set", vbox_setup_dir, "staff permissions"
        os.system('chmod -R 775 /usr/local/vbox')
        os.system('chgrp -R staff /usr/local/vbox')
    elif os.name == 'posix':
        print "Set permissions directory for", vbox_setup_dir, "!"
        print "   example: chmod -R 755", vbox_setup_dir
        print "   example: chown -R your_user", vbox_setup_dir


	# Todo
    # change vm uuid before add it
    # test if the vdi already exists
    

    # replace uuid in xml machine file before create
    # create it with the right xml
